# Excel表格结构识别优化

本文档介绍财务分析程序中对Excel表格结构识别的优化，包括模板学习、多级表头处理、单位转换等功能。

## 1. 表格结构识别增强

### 1.1 关键字段识别优化

- **扩展关键词匹配模式**：增加了更多的关键词，支持多种表述方式的财务科目识别
- **模糊匹配**：允许部分匹配和容错识别，提高识别准确率
- **上下文感知识别**：利用项目所在位置和相邻项目辅助判断其分类

### 1.2 表格布局适配

- **多种布局支持**：同时支持上表头/左表头、上日期/左日期四种主要布局模式
- **自动检测布局**：根据表格结构特征自动判断表格的布局类型
- **多级表头处理**：解析并合并多级表头，支持复杂的表头结构
- **合并单元格处理**：识别并处理Excel中的合并单元格

### 1.3 数据预处理

- **数值格式统一**：处理千分位、百分比等格式，转换为标准数值
- **单位自动识别与转换**：检测数值单位（元、万元、亿元），并进行统一转换
- **缺失值处理**：识别并适当处理数据中的缺失值
- **特殊字符处理**：清理文本中的特殊字符和无关信息

### 1.4 验证机制

- **资产负债平衡检查**：验证资产是否等于负债加所有者权益
- **损益表计算逻辑验证**：检查收入、成本与利润的计算关系
- **数据合理性验证**：对异常数据进行标记和提示
- **验证报告生成**：提供详细的数据验证报告，指出潜在问题

### 1.5 容错处理

- **多方案尝试**：当主要识别方法失败时，自动尝试多种备选方案
- **无法识别字段记录**：记录并报告识别过程中的问题
- **提供交互确认**：在UI中显示处理日志，便于用户了解处理过程
- **处理日志保存**：记录处理过程，便于后期分析和改进

## 2. 模板学习功能

### 2.1 模板存储模块

新增的`TemplateStore`类实现了表格模板的存储和管理功能：

- **模板提取**：从成功处理的表格中提取结构特征
- **模板存储**：将模板保存为JSON格式，便于后续使用
- **模板匹配**：对新表格进行相似度评分，找出最匹配的模板
- **模板管理**：支持模板的查看、使用和清除

### 2.2 模板学习流程

1. **特征提取**：从成功处理的表格中提取关键特征
   - 关键行索引和内容
   - 表头结构
   - 成功匹配的模式
   - 数据列分布

2. **模板生成**：基于提取的特征创建表格模板
   - 给每个模板生成唯一标识
   - 记录使用次数和最后使用时间
   - 存储成功的匹配模式

3. **模板匹配**：处理新表格时尝试使用已有模板
   - 计算新表格与已有模板的相似度
   - 选择最匹配的模板应用
   - 匹配失败时回退到通用识别方法

4. **模板优化**：根据使用情况不断优化模板
   - 更新使用频率信息
   - 增强常用模板的匹配优先级
   - 扩展成功模式的覆盖范围

### 2.3 模板存储结构

模板以JSON格式存储，主要包含以下信息：

```json
{
  "template_id": {
    "sheet_type": "balance_sheet",
    "columns": ["列1", "列2", "..."],
    "key_rows": [[行索引, "行内容"], ...],
    "column_count": 数字,
    "successful_patterns": ["模式1", "模式2", "..."],
    "created_at": "创建时间",
    "usage_count": 使用次数,
    "last_used": "最后使用时间"
  }
}
```

## 3. 用户界面增强

### 3.1 新增选项

- **模板使用选项**：控制是否使用和保存表格模板
- **验证选项**：开启数据验证和验证报告显示
- **单位设置**：选择目标单位和是否自动检测单位
- **Excel处理选项**：控制多级表头、合并单元格和模糊匹配功能

### 3.2 高级选项页面

增加了高级选项页面，包含以下功能：

- **模板管理**：查看和清除已保存的模板
- **单位设置**：配置数值单位转换选项
- **Excel处理选项**：控制表格处理的具体行为

### 3.3 处理日志显示

- 在主界面添加日志显示区域，实时显示处理进度和结果
- 提供清除日志的功能
- 处理完成后显示统计信息

## 4. 使用建议

### 4.1 首次使用

首次处理新类型的表格时：

1. 确保"保存模板"选项开启
2. 勾选"验证数据"和"显示验证报告"选项
3. 完成处理后查看验证报告，确保数据正确

### 4.2 后续使用

对于相似结构的表格：

1. 保持"使用模板"选项开启以提高处理效率
2. 如有需要，可在高级选项中管理和优化模板

### 4.3 遇到问题时

如果处理结果不正确：

1. 查看处理日志，了解识别过程
2. 尝试关闭"使用模板"选项，使用通用识别方法
3. 检查验证报告中的警告信息
4. 必要时清除已保存的模板，重新开始学习过程 