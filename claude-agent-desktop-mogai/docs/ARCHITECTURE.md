# Towngas Manus 项目架构文档

> 本文档描述 Towngas Manus 项目的整体架构设计、技术选型、核心模块和数据流程。

---

## 1. 项目概述

**Towngas Manus** 是面向香港中华煤气公司的企业级 AI Agent 桌面应用平台。基于 **Claude Agent SDK** 构建，采用"通用 Agent 运行时 + 行业领域包"的可复用架构模式。

### 核心理念

```
┌─────────────────────────────────────────────────────────────┐
│                    设计哲学                                   │
├─────────────────────────────────────────────────────────────┤
│  "1 Main Agent + N Skills + M Subagents"                    │
│                                                             │
│  • 通用运行时 - 不硬编码任何行业逻辑                           │
│  • 领域包    - 通过技能(Skills)注入业务能力                    │
│  • 可扩展    - 支持子代理(Subagent)协作                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 整体架构图

### 2.1 系统分层架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           用户层 (User Layer)                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Electron 桌面应用窗口                          │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐       │   │
│  │  │  会话列表  │ │  聊天界面  │ │  技能面板  │ │  设置页面  │       │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          前端层 (Frontend Layer)                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      Vue 3 + TypeScript                          │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │   │
│  │  │  Components │ │    API      │ │    Types    │               │   │
│  │  │  (Vue SFC)  │ │  (Axios)    │ │ (TypeScript)│               │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                          HTTP / SSE (Server-Sent Events)
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          后端层 (Backend Layer)                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    FastAPI + Python 3.11+                        │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │   │
│  │  │   REST API   │ │  SSE Stream  │ │   Routes     │            │   │
│  │  │   Routes     │ │   Handler    │ │   (routes.py)│            │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                    │
│  ┌─────────────────────────────────┼───────────────────────────────┐   │
│  │                     Core 核心模块 │                               │   │
│  │  ┌────────────┐ ┌────────────┐ ┌─┴──────────┐ ┌────────────┐   │   │
│  │  │   Agent    │ │  Session   │ │   Skills   │ │  Context   │   │   │
│  │  │   Engine   │ │  Manager   │ │  Registry  │ │  Manager   │   │   │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         外部服务层 (External Layer)                      │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐                 │
│  │   Claude API  │ │   TOP 系统    │ │   燃气管网    │                 │
│  │  (Anthropic)  │ │  (生产系统)   │ │   监控系统    │                 │
│  └───────────────┘ └───────────────┘ └───────────────┘                 │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 技术栈总览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           技术栈全景图                                   │
├───────────────────┬───────────────────┬─────────────────────────────────┤
│      桌面封装      │       前端        │            后端                 │
├───────────────────┼───────────────────┼─────────────────────────────────┤
│  Electron         │  Vue 3            │  Python 3.11+                   │
│  Node.js          │  TypeScript       │  FastAPI                        │
│  IPC 通信         │  Vite             │  Uvicorn                        │
│  窗口管理         │  Axios            │  Pydantic v2                    │
│                   │  marked           │  Anthropic SDK                  │
│                   │  highlight.js     │  simpleeval                     │
│                   │  DOMPurify        │                                 │
├───────────────────┴───────────────────┴─────────────────────────────────┤
│                           部署方式                                      │
├─────────────────────────────────────────────────────────────────────────┤
│  Docker + Docker Compose                                                │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 目录结构

```
claude-agent-desktop-mogai/
│
├── 📁 backend/                      # Python 后端服务
│   ├── 📁 app/
│   │   ├── 📄 main.py              # FastAPI 应用入口
│   │   ├── 📁 api/
│   │   │   └── 📄 routes.py        # REST API 路由定义
│   │   ├── 📁 core/
│   │   │   ├── 📄 config.py        # 配置管理 (环境变量)
│   │   │   ├── 📄 agent_engine.py  # 🔥 Agent 执行引擎
│   │   │   ├── 📄 session_manager.py # 会话状态管理
│   │   │   ├── 📄 skills_registry.py # 🔥 技能注册中心
│   │   │   └── 📄 context_manager.py # 上下文压缩管理
│   │   └── 📁 models/
│   │       └── 📄 schemas.py       # Pydantic 数据模型
│   ├── 📁 skills/                  # 技能模块目录 (可扩展)
│   ├── 📁 data/                    # 数据存储 (会话、配置)
│   └── 📄 requirements.txt         # Python 依赖
│
├── 📁 frontend/                     # Vue 3 前端应用
│   ├── 📁 src/
│   │   ├── 📄 App.vue              # 根组件
│   │   ├── 📄 main.ts              # Vue 应用入口
│   │   ├── 📁 api/
│   │   │   └── 📄 chat.ts          # API 客户端封装
│   │   ├── 📁 components/
│   │   │   ├── 📄 ChatInterface.vue # 🔥 聊天界面
│   │   │   ├── 📄 SessionList.vue  # 会话列表
│   │   │   └── 📄 SkillPanel.vue   # 技能面板
│   │   └── 📁 types/
│   │       └── 📄 index.ts         # TypeScript 类型定义
│   ├── 📄 package.json             # 前端依赖
│   └── 📄 vite.config.ts           # Vite 构建配置
│
├── 📁 electron/                     # Electron 桌面封装
│   ├── 📄 main.js                  # 主进程 (窗口、进程管理)
│   ├── 📄 preload.js               # 预加载脚本 (安全 IPC 桥接)
│   └── 📄 package.json             # Electron 依赖
│
├── 📁 docs/                         # 项目文档
│   ├── 📄 PRD-Towngas-Manus.md     # 产品需求文档
│   ├── 📄 EVOLUTION-ROADMAP.md     # 演进路线图
│   └── 📄 ARCHITECTURE.md          # 本架构文档
│
├── 📄 docker-compose.yml           # Docker 编排配置
├── 📄 Dockerfile                   # 容器构建文件
└── 📄 README.md                    # 项目说明
```

---

## 4. 核心模块详解

### 4.1 Agent Engine (agent_engine.py)

Agent 执行引擎是整个系统的核心，负责与 Claude API 交互并协调工具调用。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Agent Engine 内部结构                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────┐                                                   │
│  │   用户消息输入   │                                                   │
│  └────────┬────────┘                                                   │
│           │                                                             │
│           ▼                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      消息预处理                                  │   │
│  │  • 加载会话历史 (Session Manager)                                │   │
│  │  • 上下文压缩检查 (Context Manager)                              │   │
│  │  • 构建 Claude API 消息格式                                      │   │
│  └────────────────────────────────┬────────────────────────────────┘   │
│                                   │                                     │
│                                   ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                 Claude API 调用 (流式)                           │   │
│  │  • 携带工具定义 (Skills → Tools)                                 │   │
│  │  • SSE 流式返回                                                  │   │
│  └────────────────────────────────┬────────────────────────────────┘   │
│                                   │                                     │
│                    ┌──────────────┴──────────────┐                     │
│                    │                             │                      │
│                    ▼                             ▼                      │
│           ┌────────────────┐           ┌────────────────┐              │
│           │   文本响应      │           │   工具调用      │              │
│           │   (直接返回)    │           │   (需要执行)    │              │
│           └────────────────┘           └───────┬────────┘              │
│                                                   │                      │
│                                                   ▼                      │
│                                          ┌────────────────┐              │
│                                          │ Skills Registry │              │
│                                          │   执行技能       │              │
│                                          └───────┬────────┘              │
│                                                   │                      │
│                                                   ▼                      │
│                                          ┌────────────────┐              │
│                                          │  返回工具结果   │              │
│                                          │  继续对话       │              │
│                                          └────────────────┘              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Skills Registry (skills_registry.py)

技能注册中心采用插件化设计，支持动态注册和执行技能。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Skills Registry 架构                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   技能定义结构:                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  Skill {                                                         │  │
│   │    name: string          # 技能名称 (唯一标识)                   │  │
│   │    description: string   # 技能描述 (Claude 理解用)              │  │
│   │    parameters: dict      # JSON Schema 参数定义                 │  │
│   │    handler: callable     # 执行函数                             │  │
│   │    category: string      # 分类 (general/towngas/system)        │  │
│   │  }                                                               │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   内置技能:                                                             │
│   ┌───────────────┬───────────────────────────────────────────────┐   │
│   │  get_time     │  获取当前时间                                   │   │
│   │  calculate    │  数学表达式计算                                 │   │
│   │  echo_test    │  回显测试 (调试用)                              │   │
│   │  query_station│  场站信息查询                                   │   │
│   └───────────────┴───────────────────────────────────────────────┘   │
│                                                                         │
│   注册流程:                                                             │
│                                                                         │
│   ┌──────────┐    ┌──────────────┐    ┌──────────────────┐            │
│   │ 定义技能  │───▶│ 注册到中心   │───▶│ 转换为 Claude Tool│            │
│   │ (Python) │    │ (register)  │    │ (get_claude_tools)│            │
│   └──────────┘    └──────────────┘    └──────────────────┘            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.3 Session Manager (session_manager.py)

会话管理器负责持久化用户对话历史。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       Session Manager 数据流                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   会话存储结构 (JSON 文件):                                             │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  {                                                                │  │
│   │    "session_id": "uuid-xxx",                                     │  │
│   │    "title": "关于燃气管网的讨论",                                 │  │
│   │    "created_at": "2024-01-15T10:30:00",                          │  │
│   │    "updated_at": "2024-01-15T11:45:00",                          │  │
│   │    "messages": [                                                  │  │
│   │      {"role": "user", "content": "..."},                         │  │
│   │      {"role": "assistant", "content": "..."}                     │  │
│   │    ]                                                              │  │
│   │  }                                                                │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   核心操作:                                                             │
│                                                                         │
│   ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐ │
│   │  create_session │     │  get_session    │     │  add_message    │ │
│   │  创建新会话      │     │  加载会话历史   │     │  追加消息       │ │
│   └─────────────────┘     └─────────────────┘     └─────────────────┘ │
│                                                                         │
│   存储位置: backend/data/sessions/                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.4 Context Manager (context_manager.py)

上下文管理器实现智能压缩，优化 Token 使用。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       Context Manager 压缩策略                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Token 估算算法 (中英文混合):                                          │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  estimate_tokens(text):                                         │  │
│   │    chinese_chars = 统计中文字符                                  │  │
│   │    other_chars = 总长度 - 中文字符                               │  │
│   │    tokens = chinese_chars / 1.5 + other_chars / 4               │  │
│   │    return max(tokens, 1)                                        │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   压缩触发条件:                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  当前 Token 数 > CONTEXT_WINDOW_LIMIT (180000) 的 80%           │  │
│   │                      │                                          │  │
│   │                      ▼                                          │  │
│   │  ┌─────────────────────────────────────────────────────────┐   │  │
│   │  │  压缩策略:                                               │   │  │
│   │  │  1. 保留系统提示词 (System Prompt)                       │   │  │
│   │  │  2. 保留最近 N 轮对话                                    │   │  │
│   │  │  3. 对早期对话生成摘要                                   │   │  │
│   │  │  4. 合并为新的上下文                                     │   │  │
│   │  └─────────────────────────────────────────────────────────┘   │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 数据流与交互

### 5.1 完整请求流程

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                              完整请求处理流程                                     │
└──────────────────────────────────────────────────────────────────────────────────┘

用户                      前端                      后端                    Claude API
 │                         │                         │                         │
 │  1. 输入消息            │                         │                         │
 │────────────────────────▶│                         │                         │
 │                         │                         │                         │
 │                         │  2. POST /chat/stream   │                         │
 │                         │────────────────────────▶│                         │
 │                         │                         │                         │
 │                         │                         │  3. 加载会话历史        │
 │                         │                         │────────┐                │
 │                         │                         │        │                │
 │                         │                         │◀───────┘                │
 │                         │                         │                         │
 │                         │                         │  4. 检查上下文长度      │
 │                         │                         │────────┐                │
 │                         │                         │        │                │
 │                         │                         │◀───────┘                │
 │                         │                         │                         │
 │                         │                         │  5. 获取技能定义        │
 │                         │                         │────────┐                │
 │                         │                         │        │                │
 │                         │                         │◀───────┘                │
 │                         │                         │                         │
 │                         │                         │  6. 调用 Claude API     │
 │                         │                         │────────────────────────▶│
 │                         │                         │                         │
 │                         │  7. SSE 流式响应        │                         │
 │                         │◀────────────────────────│◀────────────────────────│
 │                         │  (text_delta chunks)    │                         │
 │                         │                         │                         │
 │  8. 实时显示响应        │                         │                         │
 │◀────────────────────────│                         │                         │
 │                         │                         │                         │
 │                         │  9. [DONE] 事件         │                         │
 │                         │◀────────────────────────│                         │
 │                         │                         │                         │
 │                         │  10. POST /sessions/xxx/messages                   │
 │                         │────────────────────────▶│                         │
 │                         │  (保存对话历史)         │                         │
 │                         │                         │                         │
```

### 5.2 工具调用流程

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                              工具调用处理流程                                     │
└──────────────────────────────────────────────────────────────────────────────────┘

Claude API                Agent Engine               Skills Registry
    │                           │                           │
    │  1. 返回 tool_use         │                           │
    │◀──────────────────────────│                           │
    │  {                        │                           │
    │    "name": "get_time",    │                           │
    │    "input": {}            │                           │
    │  }                        │                           │
    │                           │                           │
    │                           │  2. 解析工具调用          │
    │                           │────────┐                  │
    │                           │        │                  │
    │                           │◀───────┘                  │
    │                           │                           │
    │                           │  3. 调用技能执行器        │
    │                           │──────────────────────────▶│
    │                           │  execute("get_time", {})  │
    │                           │                           │
    │                           │                           │  4. 执行技能
    │                           │                           │────────┐
    │                           │                           │        │
    │                           │                           │◀───────┘
    │                           │                           │
    │                           │  5. 返回执行结果          │
    │                           │◀──────────────────────────│
    │                           │  {"time": "2024-01-15..."}│
    │                           │                           │
    │  6. 发送 tool_result      │                           │
    │──────────────────────────▶│                           │
    │  {                        │                           │
    │    "tool_use_id": "xxx",  │                           │
    │    "content": "..."       │                           │
    │  }                        │                           │
    │                           │                           │
    │  7. 继续对话，返回文本    │                           │
    │◀──────────────────────────│                           │
    │                           │                           │
```

### 5.3 SSE 流式响应机制

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                           SSE (Server-Sent Events) 机制                           │
└──────────────────────────────────────────────────────────────────────────────────┘

后端 (FastAPI)                              前端 (Vue)
     │                                          │
     │  async def event_generator():            │
     │    async for chunk in stream:            │
     │      ┌────────────────────────┐          │
     │      │ data: {"type":"text",  │─────────▶│  EventSource.onmessage
     │      │       "content":"你好"}│          │  → 更新 UI
     │      └────────────────────────┘          │
     │                                          │
     │      ┌────────────────────────┐          │
     │      │ data: {"type":"text",  │─────────▶│  追加到消息内容
     │      │       "content":"世界"}│          │
     │      └────────────────────────┘          │
     │                                          │
     │      ┌────────────────────────┐          │
     │      │ data: [DONE]           │─────────▶│  关闭连接，完成渲染
     │      └────────────────────────┘          │
     │                                          │

事件格式:
┌───────────────────────────────────────────────────────────────────────────────┐
│  data: {"type": "text", "content": "部分文本内容"}                            │
│  data: {"type": "tool_use", "name": "技能名", "input": {...}}                 │
│  data: {"type": "tool_result", "content": "结果"}                             │
│  data: [DONE]                                                                 │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 安全机制

### 6.1 XSS 防护

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                              XSS 防护机制                                         │
└──────────────────────────────────────────────────────────────────────────────────┘

用户输入 → Markdown 渲染 → DOMPurify 清洗 → 安全 HTML 输出

┌──────────────────────────────────────────────────────────────────────────────┐
│  ChatInterface.vue 中的实现:                                                 │
│                                                                              │
│  const renderMarkdown = (content: string): string => {                      │
│    // Step 1: Markdown 转 HTML                                               │
│    const rawHtml = marked.parse(content)                                    │
│                                                                              │
│    // Step 2: DOMPurify 清洗                                                 │
│    return DOMPurify.sanitize(rawHtml, {                                     │
│      ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'code', 'pre',               │
│                      'ul', 'ol', 'li', 'a', 'blockquote', 'h1'-'h6'],       │
│      ALLOWED_ATTR: ['href', 'title', 'class', 'id', 'target', 'rel']        │
│    })                                                                        │
│  }                                                                           │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 IPC 安全 (Electron)

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                           Electron IPC 安全机制                                  │
└──────────────────────────────────────────────────────────────────────────────────┘

渲染进程 ←→ 预加载脚本 ←→ 主进程
   │              │              │
   │   contextBridge.exposeInMainWorld     │
   │◀─────────────────────────────────────▶│
   │              │              │
   │   仅暴露白名单 API                     │
   │              │              │
   │              │   ipcMain.handle        │
   │              │◀───────────────────────▶│
   │              │              │

危险协议阻止列表:
┌──────────────────────────────────────────────────────────────────────────────┐
│  const dangerousProtocols = [                                                │
│    'javascript:',   // 防止 JS 注入                                          │
│    'data:',         // 防止 Data URL 攻击                                    │
│    'vbscript:',     // 防止 VBScript 攻击                                    │
│    'file:',         // 防止本地文件访问                                      │
│    'about:',        // 防止 about:blank 攻击                                 │
│    'blob:',         // 防止 Blob URL 攻击                                    │
│    'filesystem:'    // 防止文件系统访问                                      │
│  ]                                                                           │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 配置管理

### 7.1 后端配置 (config.py)

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                              后端配置项                                           │
└──────────────────────────────────────────────────────────────────────────────────┘

环境变量                    默认值                    说明
───────────────────────────────────────────────────────────────────────────────────
ANTHROPIC_API_KEY          (必填)                   Claude API 密钥
MODEL_NAME                 claude-sonnet-4-20250514  使用的模型
MAX_TOKENS                 4096                     单次响应最大 Token
CONTEXT_WINDOW_LIMIT       180000                   上下文窗口限制
LOG_LEVEL                  INFO                     日志级别
HOST                       0.0.0.0                  服务监听地址
PORT                       8000                     服务端口

配置加载优先级:
┌────────────────────────────────────────────────────────────────────────────────┐
│  1. 环境变量 (最高优先级)                                                       │
│  2. .env 文件                                                                  │
│  3. 默认值 (最低优先级)                                                         │
└────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 前端构建配置 (vite.config.ts)

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                              Vite 构建配置                                        │
└──────────────────────────────────────────────────────────────────────────────────┘

开发服务器代理:
┌────────────────────────────────────────────────────────────────────────────────┐
│  /api/*      → http://localhost:8000/api/*                                     │
│  /chat/*     → http://localhost:8000/chat/*                                    │
│  /sessions/* → http://localhost:8000/sessions/*                                │
│  /skills/*   → http://localhost:8000/skills/*                                  │
└────────────────────────────────────────────────────────────────────────────────┘

代码分包策略:
┌────────────────────────────────────────────────────────────────────────────────┐
│  manualChunks: {                                                                │
│    vue: ['vue'],                        // Vue 核心                             │
│    markdown: ['marked', 'highlight.js', // Markdown 相关                       │
│                'dompurify']                                                     │
│  }                                                                              │
└────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 部署架构

### 8.1 Docker 部署

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                              Docker 部署架构                                      │
└──────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Docker Container                                   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         backend (FastAPI)                                │   │
│  │                           Port: 8000                                     │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │   │
│  │  │   Uvicorn   │ │   Agent     │ │   Skills    │ │   Session   │       │   │
│  │  │   Server    │ │   Engine    │ │   Registry  │ │   Manager   │       │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌──────────────────────────┐     ┌──────────────────────────────────────┐    │
│  │    /app/data             │     │    环境变量                           │    │
│  │    (持久化存储)          │     │    - ANTHROPIC_API_KEY               │    │
│  │    - sessions/           │     │    - MODEL_NAME                      │    │
│  │    - config/             │     │    - LOG_LEVEL                       │    │
│  └──────────────────────────┘     └──────────────────────────────────────┘    │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

docker-compose.yml:
┌────────────────────────────────────────────────────────────────────────────────┐
│  services:                                                                      │
│    backend:                                                                     │
│      build: .                                                                   │
│      ports:                                                                     │
│        - "8000:8000"                                                            │
│      volumes:                                                                   │
│        - ./data:/app/data                                                       │
│      environment:                                                               │
│        - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}                                │
│      healthcheck:                                                               │
│        test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]         │
│        interval: 30s                                                            │
│        timeout: 10s                                                             │
│        retries: 3                                                               │
└────────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 桌面应用启动流程

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                           Electron 应用启动流程                                   │
└──────────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────┐
                    │   electron/main.js
                    │   启动入口       │
                    └────────┬────────┘
                             │
            ┌────────────────┼────────────────┐
            │                │                │
            ▼                ▼                ▼
    ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
    │  启动后端进程  │ │  创建窗口     │ │  加载前端     │
    │  (Python)     │ │  (BrowserWindow)│ │  (Vue App)   │
    └───────┬───────┘ └───────────────┘ └───────────────┘
            │
            ▼
    ┌───────────────┐
    │  检测后端就绪  │
    │  (健康检查)    │
    └───────┬───────┘
            │
            ▼
    ┌───────────────┐
    │  显示窗口     │
    │  应用就绪     │
    └───────────────┘
```

---

## 9. 扩展点与未来演进

### 9.1 技能扩展示意

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                              技能扩展示意图                                       │
└──────────────────────────────────────────────────────────────────────────────────┘

当前内置技能                     未来扩展方向
┌──────────────────┐            ┌──────────────────────────────────────┐
│ • get_time       │            │ • TOP 系统集成 (生产数据查询)         │
│ • calculate      │            │ • 管网监控 (实时状态获取)             │
│ • echo_test      │    ────▶   │ • 场站管理 (设备巡检记录)             │
│ • query_station  │            │ • 客户服务 (工单处理)                 │
└──────────────────┘            │ • 知识库检索 (RAG 集成)              │
                                └──────────────────────────────────────┘

扩展步骤:
┌────────────────────────────────────────────────────────────────────────────────┐
│  1. 在 backend/skills/ 目录创建新技能文件                                       │
│  2. 继承 Skill 基类，定义 name/description/parameters/handler                  │
│  3. 在 Skills Registry 中注册                                                  │
│  4. Claude 自动发现并可调用新技能                                               │
└────────────────────────────────────────────────────────────────────────────────┘
```

### 9.2 多 Agent 协作演进

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          未来: 多 Agent 协作架构                                  │
└──────────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────────────┐
                    │          Main Agent                 │
                    │       (任务路由与协调)               │
                    └─────────────────┬───────────────────┘
                                      │
         ┌────────────────────────────┼────────────────────────────┐
         │                            │                            │
         ▼                            ▼                            ▼
┌─────────────────┐        ┌─────────────────┐        ┌─────────────────┐
│  Subagent A     │        │  Subagent B     │        │  Subagent C     │
│  (数据分析)     │        │  (文档处理)     │        │  (系统监控)     │
└─────────────────┘        └─────────────────┘        └─────────────────┘

演进路线:
┌────────────────────────────────────────────────────────────────────────────────┐
│  Phase 1: 单 Agent + 技能          (当前状态)                                   │
│  Phase 2: 单 Agent + RAG 知识库    (Q2 2024)                                   │
│  Phase 3: 多 Agent 协作            (Q3 2024)                                   │
│  Phase 4: Agent OS 平台            (Q4 2024)                                   │
└────────────────────────────────────────────────────────────────────────────────┘
```

---

## 10. 快速参考

### 10.1 关键文件速查表

| 功能模块 | 关键文件 | 说明 |
|---------|---------|------|
| 后端入口 | `backend/app/main.py` | FastAPI 应用启动 |
| API 路由 | `backend/app/api/routes.py` | 所有 REST 端点 |
| Agent 引擎 | `backend/app/core/agent_engine.py` | Claude API 交互 |
| 技能注册 | `backend/app/core/skills_registry.py` | 技能管理 |
| 会话管理 | `backend/app/core/session_manager.py` | 对话持久化 |
| 前端入口 | `frontend/src/main.ts` | Vue 应用启动 |
| 聊天界面 | `frontend/src/components/ChatInterface.vue` | 主交互组件 |
| API 客户端 | `frontend/src/api/chat.ts` | HTTP/SSE 封装 |
| Electron 主进程 | `electron/main.js` | 窗口与进程管理 |

### 10.2 API 端点

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                              REST API 端点                                        │
└──────────────────────────────────────────────────────────────────────────────────┘

POST   /chat/stream              流式聊天 (SSE)
GET    /sessions                 获取会话列表
GET    /sessions/{id}            获取单个会话
POST   /sessions                 创建新会话
DELETE /sessions/{id}            删除会话
POST   /sessions/{id}/messages   添加消息到会话
GET    /skills                   获取可用技能列表
GET    /api/health               健康检查
```

---

## 附录: 架构决策记录 (ADR)

### ADR-001: 为什么选择 FastAPI + Vue 3 + Electron?

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│  决策: 采用 FastAPI (后端) + Vue 3 (前端) + Electron (桌面) 三层架构            │
├──────────────────────────────────────────────────────────────────────────────────┤
│  理由:                                                                          │
│  1. FastAPI: 原生异步支持，适合 SSE 流式响应；自动 API 文档                      │
│  2. Vue 3: 组合式 API，更好的 TypeScript 支持，学习曲线平缓                      │
│  3. Electron: 跨平台桌面支持，企业环境部署友好                                  │
│                                                                                 │
│  替代方案考虑:                                                                   │
│  • Tauri (更轻量，但 Rust 后端学习成本高)                                       │
│  • React (生态更大，但团队更熟悉 Vue)                                           │
└──────────────────────────────────────────────────────────────────────────────────┘
```

### ADR-002: 为什么使用 SSE 而非 WebSocket?

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│  决策: 使用 Server-Sent Events (SSE) 实现流式响应                               │
├──────────────────────────────────────────────────────────────────────────────────┤
│  理由:                                                                          │
│  1. 单向数据流: AI 响应是 服务端→客户端，SSE 足够                               │
│  2. 简单性: SSE 基于 HTTP，无需额外协议升级                                     │
│  3. 自动重连: 浏览器原生支持断线重连                                            │
│  4. Claude API: Anthropic SDK 流式响应天然适配 SSE                              │
│                                                                                 │
│  何时不选 SSE:                                                                   │
│  • 需要双向实时通信 → WebSocket                                                 │
│  • 需要二进制数据 → WebSocket                                                   │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

*文档版本: 1.0 | 最后更新: 2024-02*
